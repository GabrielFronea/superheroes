const express = require('express');
const mysql = require('mysql2');
const cors = require('cors');

const app = express();

// SetÄƒm limite mari pentru JSON deoarece imaginile Base64 ocupÄƒ mult spaÈ›iu
app.use(express.json({ limit: '50mb' })); 
app.use(express.urlencoded({ limit: '50mb', extended: true }));
app.use(cors());

const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: '',
    database: 'superheroes'
});

db.connect(err => {
    if (err) {
        console.error('âŒ Eroare MySQL:', err.message);
    } else {
        console.log('âœ… Backend conectat la MySQL');
    }
});

// --- RUTE API ---

// 1. GET: Preluare eroi cu Paginare, LimitÄƒ, CÄƒutare GlobalÄƒ È™i Filtru Univers
app.get('/api/supereroi', (req, res) => {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const offset = (page - 1) * limit;
    const search = req.query.search || ""; // PreluÄƒm textul cÄƒutat
    const publisher = req.query.publisher || "Toti";

    let sql = "SELECT * FROM `data` WHERE 1=1 ";
    let params = [];

    // AdÄƒugÄƒm filtrarea globalÄƒ prin SQL pentru cÄƒutare
    if (search !== "") {
        sql += " AND JSON_UNQUOTE(JSON_EXTRACT(`data`, '$.name')) LIKE ? ";
        params.push(`%${search}%`);
    }

    // AdÄƒugÄƒm filtrarea dupÄƒ univers Ã®n SQL
    if (publisher !== "Toti") {
        sql += " AND JSON_UNQUOTE(JSON_EXTRACT(`data`, '$.biography.publisher')) = ? ";
        params.push(publisher);
    }

    // Paginarea
    sql += " LIMIT ? OFFSET ?";
    params.push(limit, offset);

    db.query(sql, params, (err, results) => {
        if (err) return res.status(500).json(err);
        const eroi = results.map(row => ({ id: row.id, ...JSON.parse(row.data) }));
        res.json(eroi);
    });
});

// 2. GET: Extragere DINAMICÄ‚ a universurilor pentru dropdown (George Lucas, Marvel, etc.)
app.get('/api/supereroi/universuri', (req, res) => {
    const sql = "SELECT DISTINCT JSON_UNQUOTE(JSON_EXTRACT(`data`, '$.biography.publisher')) AS univers FROM `data` WHERE JSON_EXTRACT(`data`, '$.biography.publisher') IS NOT NULL ORDER BY univers ASC";
    
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        // FiltrÄƒm valorile nule sau invalide
        const lista = results.map(r => r.univers).filter(u => u && u !== "null");
        res.json(lista);
    });
});

// 3. GET: Preluare detalii pentru un singur erou dupÄƒ ID
app.get('/api/supereroi/:id', (req, res) => {
    const sql = "SELECT * FROM `data` WHERE id = ?";
    db.query(sql, [req.params.id], (err, result) => {
        if (err || result.length === 0) return res.status(404).send("Erou negÄƒsit.");
        res.json({ id: result[0].id, ...JSON.parse(result[0].data) });
    });
});

// 4. POST: AdÄƒugare erou nou Ã®n baza de date
app.post('/api/supereroi', (req, res) => {
    const dataString = JSON.stringify(req.body);
    const sql = "INSERT INTO `data` (`data`) VALUES (?)";
    db.query(sql, [dataString], (err, result) => {
        if (err) return res.status(500).json(err);
        res.json({ message: "Erou creat!", id: result.insertId });
    });
});

// 5. PUT: Editare erou existent (CerinÈ›Äƒ obligatorie Panou Control)
app.put('/api/supereroi/:id', (req, res) => {
    const dataString = JSON.stringify(req.body);
    const sql = "UPDATE `data` SET `data` = ? WHERE id = ?";
    db.query(sql, [dataString, req.params.id], (err, result) => {
        if (err) return res.status(500).json(err);
        res.json({ message: "Erou actualizat!" });
    });
});

// 6. DELETE: È˜tergere erou din baza de date
app.delete('/api/supereroi/:id', (req, res) => {
    const sql = "DELETE FROM `data` WHERE id = ?";
    db.query(sql, [req.params.id], (err, result) => {
        if (err) return res.status(500).json(err);
        res.json({ message: "Erou È™ters!" });
    });
});

app.listen(5000, () => console.log('ðŸš€ Server API pornit la http://localhost:5000'));